--[[
    å¸½å­ç”©é£ & é€æ˜åˆ†èº«å®Œæ•´ç‰ˆ
    åŠŸèƒ½ï¼šæ°¸ä¹…æ­»äº¡ â†’ åˆ›å»ºé€æ˜åˆ†èº« â†’ å¸½å­å›´ç»•åˆ†èº« â†’ é¼ æ ‡ç‚¹å‡»ç”©é£
    å…¼å®¹æ€§ï¼šè‡ªåŠ¨æ£€æµ‹ executor æ”¯æŒåº¦ï¼Œç»™å‡ºæç¤º
]]

if _G.HatFlingCompleteLoaded then 
    game:GetService("StarterGui"):SetCore("SendNotification", {Title="æç¤º", Text="è„šæœ¬å·²è¿è¡Œï¼Œæ— éœ€é‡å¤æ‰§è¡Œ"})
    return 
end
_G.HatFlingCompleteLoaded = true

-- ========== ç¯å¢ƒå…¼å®¹å±‚ ==========
local function safeRequire(funcName, default)
    local ok, res = pcall(function() return _G[funcName] end)
    if ok and res then return res end
    ok, res = pcall(function() return getfenv()[funcName] end)
    if ok and res then return res end
    return default
end

local cloneref = safeRequire("cloneref") or function(o) return o end
local getcustomasset = safeRequire("getcustomasset") or safeRequire("getsynasset") or function() return "" end
local gethiddengui = safeRequire("gethiddengui") or function() return cloneref(game:GetService("CoreGui")) end
local isfile = safeRequire("isfile") or function(p) local s,e=pcall(readfile,p); return s and e~=nil end
local writefile = safeRequire("writefile") or function() end
local replicatesignal = safeRequire("replicatesignal")
local sethiddenproperty = safeRequire("sethiddenproperty")
local isnetworkowner = safeRequire("isnetworkowner")

-- æœåŠ¡
local Debris = cloneref(game:GetService("Debris"))
local CoreGui = cloneref(game:GetService("CoreGui"))
local Players = cloneref(game:GetService("Players"))
local RunService = cloneref(game:GetService("RunService"))
local UserInputService = cloneref(game:GetService("UserInputService"))
local TweenService = cloneref(game:GetService("TweenService"))
local HttpService = cloneref(game:GetService("HttpService"))
local StarterGui = cloneref(game:GetService("StarterGui"))
local Camera = workspace.CurrentCamera

local Player = Players.LocalPlayer
local FallenPartsDestroyHeight = workspace.FallenPartsDestroyHeight or -500

-- ========== å·¥å…·å‡½æ•° ==========
local Util = {}
Util.RandomString = function(l)
    l = l or 16
    local s = ""
    for _=1,l do s = s .. string.char(math.random(32,126)) end
    return s
end
Util.Notify = function(t)
    StarterGui:SetCore("SendNotification", {Title="å¸½å­åˆ†èº«", Text=t, Duration=5})
end
Util.Instance = function(c,p)
    local i = Instance.new(c)
    i.Name = Util.RandomString()
    i.Parent = p
    return i
end
Util.GetScreenSize = function()
    return Camera and Camera.ViewportSize or Vector2.new(512,512)
end
Util.LinkDestroyI2C = function(a,b)
    a.Destroying:Once(function() b:Disconnect() end)
end
Util.LinkDestroyI2I = function(a,b)
    a.Destroying:Once(function() b:Destroy() end)
end
Util.DeepcopyTable = function(t)
    local c = {}
    for k,v in pairs(t) do
        if type(v)=="table" then v=Util.DeepcopyTable(v) end
        c[k]=v
    end
    return c
end
Util.IsNetworkOwner = function(part)
    if isnetworkowner then
        local s,d = pcall(isnetworkowner, part)
        if s then return d end
    end
    local s,d = pcall(function() return part.ReceiveAge == 0 end)
    if s then return d end
    return false
end

-- ========== åˆ›å»ºé€æ˜åˆ†èº« ==========
local function CreateHumanoidCharacter()
    local char = Util.Instance("Model")
    char.Name = "HatFlingClone"

    -- æ‰€æœ‰éƒ¨ä»¶é€æ˜
    local function makePart(name, size, pos)
        local part = Util.Instance("Part", char)
        part.Name = name
        part.Size = size
        part.Position = pos
        part.Anchored = false
        part.CanCollide = false
        part.Transparency = 1
        part.Reflectance = 0
        part.CastShadow = false
        part.TopSurface = Enum.SurfaceType.Smooth
        part.BottomSurface = Enum.SurfaceType.Smooth
        return part
    end

    local root = makePart("HumanoidRootPart", Vector3.new(2,2,1), Vector3.new(0,0,0))
    local torso = makePart("Torso", Vector3.new(2,2,1), Vector3.new(0,0,0))
    local head = makePart("Head", Vector3.new(2,1,1), Vector3.new(0,1.5,0))
    local leftArm = makePart("Left Arm", Vector3.new(1,2,1), Vector3.new(-1.5,0,0))
    local rightArm = makePart("Right Arm", Vector3.new(1,2,1), Vector3.new(1.5,0,0))
    local leftLeg = makePart("Left Leg", Vector3.new(1,2,1), Vector3.new(-0.5,-2,0))
    local rightLeg = makePart("Right Leg", Vector3.new(1,2,1), Vector3.new(0.5,-2,0))

    local function makeMotor(name, p0, p1, c0, c1)
        local motor = Instance.new("Motor6D", p0)
        motor.Name = name
        motor.Part0 = p0
        motor.Part1 = p1
        motor.C0 = c0
        motor.C1 = c1
        return motor
    end

    makeMotor("RootJoint", root, torso,
        CFrame.new(0,0,0,-1,0,0,0,0,1,0,1,0),
        CFrame.new(0,0,0,-1,0,0,0,0,1,0,1,0)
    )
    makeMotor("Neck", torso, head,
        CFrame.new(0,1,0,-1,0,0,0,0,1,0,1,0),
        CFrame.new(0,-0.5,0,-1,0,0,0,0,1,0,1,0)
    )
    makeMotor("Left Shoulder", torso, leftArm,
        CFrame.new(-1,0.5,0,0,0,-1,0,1,0,1,0,0),
        CFrame.new(0.5,0.5,0,0,0,-1,0,1,0,1,0,0)
    )
    makeMotor("Right Shoulder", torso, rightArm,
        CFrame.new(1,0.5,0,0,0,1,0,1,0,-1,0,0),
        CFrame.new(-0.5,0.5,0,0,0,1,0,1,0,-1,0,0)
    )
    makeMotor("Left Hip", torso, leftLeg,
        CFrame.new(-1,-1,0,0,0,-1,0,1,0,1,0,0),
        CFrame.new(-0.5,1,0,0,0,-1,0,1,0,1,0,0)
    )
    makeMotor("Right Hip", torso, rightLeg,
        CFrame.new(1,-1,0,0,0,1,0,1,0,-1,0,0),
        CFrame.new(0.5,1,0,0,0,1,0,1,0,-1,0,0)
    )

    local hum = Util.Instance("Humanoid", char)
    hum.Name = "Humanoid"
    hum.DisplayDistanceType = Enum.HumanoidDisplayDistanceType.None
    hum.BreakJointsOnDeath = false
    hum.Health = 100
    hum.MaxHealth = 100

    char.PrimaryPart = root
    return char
end

-- ========== æ°¸ä¹…æ­»äº¡è§¦å‘å™¨ ==========
local function TriggerPermaDeath()
    if replicatesignal then
        -- æ–¹æ³•1ï¼šé€šè¿‡ replicasignal å‘é€æ­»äº¡ä¿¡å·
        pcall(replicatesignal, Player.ConnectDiedSignalBackend)
        Util.Notify("æ°¸ä¹…æ­»äº¡ä¿¡å·å·²å‘é€ (replicatesignal)")
        return true
    else
        -- æ–¹æ³•2ï¼šRCDless æ–¹æ³•ï¼ˆé€‚ç”¨äº RejectCharacterDeletions = Disabled çš„æœåŠ¡å™¨ï¼‰
        local char = Player.Character
        if char then
            -- ç§»é™¤é™¤äº†é¥°å“ä»¥å¤–çš„æ‰€æœ‰éƒ¨ä»¶
            for _,v in ipairs(char:GetChildren()) do
                if not v:IsA("Accessory") and not v:IsA("Humanoid") then
                    v:Destroy()
                end
            end
            -- è®© Humanoid æ­»äº¡
            local hum = char:FindFirstChildOfClass("Humanoid")
            if hum then
                hum.Health = 0
                hum:ChangeState(Enum.HumanoidStateType.Dead)
            end
            Util.Notify("æ°¸ä¹…æ­»äº¡è§¦å‘ (RCDless æ–¹æ³•)")
            return true
        end
    end
    Util.Notify("âš ï¸ æ— æ³•è§¦å‘æ°¸ä¹…æ­»äº¡ï¼Œè¯·æ£€æŸ¥ executor æƒé™")
    return false
end

-- ========== å¸½å­ç®¡ç† ==========
local HatManager = {
    cloneChar = nil,           -- é€æ˜åˆ†èº«
    hats = {},                 -- å½“å‰æ§åˆ¶çš„å¸½å­
    flingTargets = {},         -- ç”©é£ç›®æ ‡é˜Ÿåˆ—
    collideEnabled = true,
    followClone = true,        -- æ˜¯å¦è·Ÿéšåˆ†èº«ï¼ˆåˆ†èº«ç”±é¼ æ ‡æ§åˆ¶ç§»åŠ¨ï¼‰
    netlessSpeed = 26,
    useAngular = true,
    running = false,
    heartbeatConn = nil,
}

-- è·å–æ‰€æœ‰å¸½å­ï¼ˆé¥°å“ï¼‰
function HatManager:GetAllHats()
    local hats = {}
    local char = Player.Character
    if char then
        for _,v in ipairs(char:GetChildren()) do
            if v:IsA("Accessory") then
                table.insert(hats, v)
            end
        end
    end
    return hats
end

-- è®¾ç½®å¸½å­çŠ¶æ€ä¸ºæ‰è½ï¼ˆä»è§’è‰²åˆ†ç¦»ï¼‰
function HatManager:DetachHats()
    for _,hat in ipairs(self:GetAllHats()) do
        if sethiddenproperty then
            pcall(sethiddenproperty, hat, "BackendAccoutrementState", 2) -- InWorkspace
        else
            pcall(function() hat.BackendAccoutrementState = 2 end)
        end
        local handle = hat:FindFirstChild("Handle")
        if handle then
            handle.CanCollide = self.collideEnabled
            -- è®©å¸½å­è½»å¾®ä¸Šæµ®ï¼Œé¿å…å¡åœ°æ¿
            handle.CFrame = handle.CFrame + Vector3.new(0,2,0)
        end
    end
end

-- æ›´æ–°å¸½å­ä½ç½®ï¼ˆæ¯å¸§è°ƒç”¨ï¼‰
function HatManager:Update(dt)
    if not self.running or not self.cloneChar or not self.cloneChar.PrimaryPart then return end
    local hats = self:GetAllHats()
    self.hats = hats
    if #hats == 0 then return end

    -- ç¡®å®šç›®æ ‡ä½ç½®ï¼ˆåˆ†èº«ä½ç½® æˆ– é¼ æ ‡ä½ç½®ï¼‰
    local targetPos
    if self.followClone then
        targetPos = self.cloneChar.PrimaryPart.Position
    else
        local mousePos = UserInputService:GetMouseLocation()
        local ray = Camera:ScreenPointToRay(mousePos.X, mousePos.Y)
        local params = RaycastParams.new()
        params.FilterType = Enum.RaycastFilterType.Blacklist
        params.FilterDescendantsInstances = {self.cloneChar, Player.Character}
        local result = workspace:Raycast(ray.Origin, ray.Direction * 1000, params)
        targetPos = result and result.Position or (ray.Origin + ray.Direction * 500)
    end

    -- å¤„ç†ç”©é£ç›®æ ‡
    local flingTarget = self.flingTargets[1]
    if flingTarget then
        if flingTarget.time and os.clock() > flingTarget.time then
            table.remove(self.flingTargets, 1)
            flingTarget = nil
        elseif not flingTarget.time then
            flingTarget.time = os.clock() + (flingTarget.duration or 2)
        end
    end

    for i, hat in ipairs(hats) do
        local handle = hat:FindFirstChild("Handle")
        if handle and handle:IsA("BasePart") and Util.IsNetworkOwner(handle) then
            local targetCF
            if flingTarget then
                -- ç”©é£æ¨¡å¼ï¼šé£å‘ç›®æ ‡
                local targPos = flingTarget.target:GetPivot().Position
                targetCF = CFrame.lookAt(handle.Position, targPos)
            else
                -- å›´ç»•ç›®æ ‡ç‚¹æ’åˆ—æˆç¯
                local radius = 3 + i * 0.4
                local angle = (i / #hats) * math.pi * 2 + os.clock() * 0.8
                local offset = Vector3.new(math.cos(angle)*radius, math.sin(os.clock()*2)*0.5, math.sin(angle)*radius)
                targetCF = CFrame.new(targetPos) * CFrame.new(offset)
            end
            -- åº”ç”¨ netless ç§»åŠ¨
            self:MoveHandle(handle, dt, targetCF, flingTarget ~= nil)
        end
    end
end

-- ç§»åŠ¨å•ä¸ªå¸½å­ï¼ˆnetless æ–¹æ³•ï¼‰
function HatManager:MoveHandle(handle, dt, targetCF, spin)
    if dt <= 0 then return end
    local timing = os.clock()
    local idle = Vector3.new(math.sin(timing*14), math.sin(timing*15+1.0472), math.sin(timing*16+2.0944)) * 0.001
    if targetCF.Y < FallenPartsDestroyHeight + 5 then
        targetCF = targetCF + Vector3.new(0, FallenPartsDestroyHeight + 5 - targetCF.Y, 0)
    end
    local lastCF = handle:GetAttribute("_LastCF") or handle.CFrame
    local vel = (targetCF.Position - lastCF.Position) / dt
    if vel.Magnitude > 16384 then
        vel = vel.Unit * 16384
        targetCF = lastCF.Rotation + (lastCF.Position + vel * dt)
    end
    handle:SetAttribute("_LastCF", targetCF)
    handle.CFrame = targetCF
    handle.AssemblyLinearVelocity = Vector3.new(vel.X, math.max(vel.Y, self.netlessSpeed), vel.Z)
    if spin then
        handle.AssemblyAngularVelocity = Vector3.new(16384,16384,16384)
    elseif self.useAngular then
        handle.AssemblyAngularVelocity = idle
    else
        handle.AssemblyAngularVelocity = Vector3.zero
    end
end

-- æ·»åŠ ç”©é£ç›®æ ‡
function HatManager:AddFlingTarget(target, duration)
    if typeof(target) == "Instance" and target:IsA("Model") then
        table.insert(self.flingTargets, {target=target, duration=duration})
        Util.Notify("ğŸ¯ ç”©é£ç›®æ ‡: "..target.Name)
        return true
    end
    return false
end

-- å¯åŠ¨æµç¨‹
function HatManager:Start()
    if self.running then return end

    -- 1. è§¦å‘æ°¸ä¹…æ­»äº¡
    Util.Notify("æ­£åœ¨è§¦å‘æ°¸ä¹…æ­»äº¡...")
    local success = TriggerPermaDeath()
    if not success then
        Util.Notify("æ°¸ä¹…æ­»äº¡å¤±è´¥ï¼Œæ— æ³•ç»§ç»­")
        return
    end

    -- ç­‰å¾…ä¸€å°æ®µæ—¶é—´è®©è§’è‰²æ­»äº¡
    task.wait(0.5)

    -- 2. åˆ›å»ºé€æ˜åˆ†èº«
    self.cloneChar = CreateHumanoidCharacter()
    self.cloneChar.Parent = workspace
    -- æ”¾ç½®äºåŸè§’è‰²é™„è¿‘
    local oldChar = Player.Character
    if oldChar and oldChar.PrimaryPart then
        self.cloneChar:SetPrimaryPartCFrame(oldChar.PrimaryPart.CFrame + Vector3.new(0,3,0))
    else
        self.cloneChar:SetPrimaryPartCFrame(CFrame.new(0,10,0))
    end
    Util.Notify("é€æ˜åˆ†èº«å·²åˆ›å»º")

    -- 3. åˆ†ç¦»å¸½å­ï¼ˆä½¿å®ƒä»¬æ‰è½ï¼‰
    self:DetachHats()
    task.wait(0.2)

    -- 4. å¯åŠ¨æ›´æ–°å¾ªç¯
    self.running = true
    self.heartbeatConn = RunService.Heartbeat:Connect(function(dt)
        self:Update(dt)
    end)

    Util.Notify("âœ… å¸½å­åˆ†èº«è¿è¡Œä¸­ï¼Œå…± "..#self:GetAllHats().." ä¸ªå¸½å­")
end

function HatManager:Stop()
    self.running = false
    if self.heartbeatConn then
        self.heartbeatConn:Disconnect()
        self.heartbeatConn = nil
    end
    if self.cloneChar then
        self.cloneChar:Destroy()
        self.cloneChar = nil
    end
    -- æ¢å¤å¸½å­çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
    for _,hat in ipairs(self:GetAllHats()) do
        if sethiddenproperty then
            pcall(sethiddenproperty, hat, "BackendAccoutrementState", 4) -- Equipped
        else
            pcall(function() hat.BackendAccoutrementState = 4 end)
        end
        local handle = hat:FindFirstChild("Handle")
        if handle then handle.CanCollide = false end
    end
    Util.Notify("â¹ å·²åœæ­¢")
end

-- ========== åˆ›å»ºUI ==========
local HiddenGui = gethiddengui() or CoreGui
local ScreenGui = Util.Instance("ScreenGui", HiddenGui)
ScreenGui.Name = "HatFlingCompleteGUI"
ScreenGui.IgnoreGuiInset = true
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.DisplayOrder = 2147483647

local MainFrame = Util.Instance("Frame", ScreenGui)
MainFrame.AnchorPoint = Vector2.new(0.5,0.5)
MainFrame.Position = UDim2.new(0.5,0,0.5,0)
MainFrame.Size = UDim2.new(0,450,0,350)
MainFrame.BackgroundColor3 = Color3.new(0,0,0)
MainFrame.BackgroundTransparency = 0.1
MainFrame.BorderSizePixel = 1
MainFrame.BorderColor3 = Color3.new(1,1,1)
local UICorner = Util.Instance("UICorner", MainFrame)
UICorner.CornerRadius = UDim.new(0,8)

-- æ‹–åŠ¨
local dragToggle, dragStart, dragPos = false, nil, nil
MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragToggle = true
        dragStart = input.Position
        dragPos = MainFrame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then dragToggle = false end
        end)
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if dragToggle and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(dragPos.X.Scale, dragPos.X.Offset + delta.X, dragPos.Y.Scale, dragPos.Y.Offset + delta.Y)
    end
end)

-- ç¼©æ”¾
local resizeHandle = Util.Instance("Frame", MainFrame)
resizeHandle.AnchorPoint = Vector2.new(1,1)
resizeHandle.Position = UDim2.new(1,-10,1,-10)
resizeHandle.Size = UDim2.new(0,20,0,20)
resizeHandle.BackgroundColor3 = Color3.new(1,1,1)
resizeHandle.BackgroundTransparency = 0.5
resizeHandle.BorderSizePixel = 0
Util.Instance("UICorner", resizeHandle).CornerRadius = UDim.new(0,3)
local resizeStart, resizeSize
resizeHandle.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        resizeStart = input.Position
        resizeSize = MainFrame.Size
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if resizeStart and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = input.Position - resizeStart
        MainFrame.Size = UDim2.new(0, math.max(350, resizeSize.X.Offset + delta.X), 0, math.max(250, resizeSize.Y.Offset + delta.Y))
    end
end)
UserInputService.InputEnded:Connect(function(input)
    if resizeStart and (input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch) then
        resizeStart = nil
    end
end)

-- æ ‡é¢˜æ 
local TitleBar = Util.Instance("Frame", MainFrame)
TitleBar.Size = UDim2.new(1,0,0,35)
TitleBar.BackgroundColor3 = Color3.new(0.2,0.2,0.2)
TitleBar.BorderSizePixel = 0
local TitleText = Util.Instance("TextLabel", TitleBar)
TitleText.AnchorPoint = Vector2.new(0,0.5)
TitleText.Position = UDim2.new(0,10,0.5,0)
TitleText.Size = UDim2.new(1,-40,1,0)
TitleText.BackgroundTransparency = 1
TitleText.Font = Enum.Font.GothamBold
TitleText.TextColor3 = Color3.new(1,1,1)
TitleText.TextSize = 20
TitleText.TextXAlignment = Enum.TextXAlignment.Left
TitleText.Text = "ğŸ© å¸½å­ç”©é£ + é€æ˜åˆ†èº«"

local CloseBtn = Util.Instance("TextButton", TitleBar)
CloseBtn.AnchorPoint = Vector2.new(1,0.5)
CloseBtn.Position = UDim2.new(1,-10,0.5,0)
CloseBtn.Size = UDim2.new(0,24,0,24)
CloseBtn.BackgroundColor3 = Color3.new(1,0.3,0.3)
CloseBtn.Text = "X"
CloseBtn.TextColor3 = Color3.new(1,1,1)
CloseBtn.TextSize = 18
CloseBtn.BorderSizePixel = 0
Util.Instance("UICorner", CloseBtn).CornerRadius = UDim.new(0,4)
CloseBtn.MouseButton1Click:Connect(function() MainFrame.Visible = false end)

-- å†…å®¹åŒº
local Content = Util.Instance("Frame", MainFrame)
Content.AnchorPoint = Vector2.new(0.5,1)
Content.Position = UDim2.new(0.5,0,1,-5)
Content.Size = UDim2.new(1,-20,0,0)
Content.BackgroundColor3 = Color3.new(0.1,0.1,0.1)
Content.BorderSizePixel = 0
Util.Instance("UICorner", Content).CornerRadius = UDim.new(0,5)
Content.AutomaticSize = Enum.AutomaticSize.Y

local UIList = Util.Instance("UIListLayout", Content)
UIList.Padding = UDim.new(0,5)
UIList.FillDirection = Enum.FillDirection.Vertical
UIList.HorizontalAlignment = Enum.HorizontalAlignment.Center

local function AddButton(text, callback)
    local btn = Util.Instance("TextButton", Content)
    btn.Size = UDim2.new(1,-10,0,40)
    btn.BackgroundColor3 = Color3.new(0.3,0.3,0.3)
    btn.Text = text
    btn.TextColor3 = Color3.new(1,1,1)
    btn.TextSize = 16
    btn.BorderSizePixel = 0
    Util.Instance("UICorner", btn).CornerRadius = UDim.new(0,5)
    btn.MouseButton1Click:Connect(callback)
    return btn
end
local function AddSwitch(text, default, callback)
    local container = Util.Instance("Frame", Content)
    container.Size = UDim2.new(1,-10,0,40)
    container.BackgroundTransparency = 1
    local lbl = Util.Instance("TextLabel", container)
    lbl.AnchorPoint = Vector2.new(0,0.5)
    lbl.Position = UDim2.new(0,5,0.5,0)
    lbl.Size = UDim2.new(0.7,0,1,0)
    lbl.BackgroundTransparency = 1
    lbl.Text = text
    lbl.TextColor3 = Color3.new(1,1,1)
    lbl.TextSize = 16
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    local sw = Util.Instance("TextButton", container)
    sw.AnchorPoint = Vector2.new(1,0.5)
    sw.Position = UDim2.new(1,-5,0.5,0)
    sw.Size = UDim2.new(0,50,0,30)
    sw.BackgroundColor3 = default and Color3.new(0,1,0) or Color3.new(0.5,0.5,0.5)
    sw.Text = default and "ON" or "OFF"
    sw.TextColor3 = Color3.new(1,1,1)
    sw.TextSize = 14
    sw.BorderSizePixel = 0
    Util.Instance("UICorner", sw).CornerRadius = UDim.new(0,4)
    local state = default
    sw.MouseButton1Click:Connect(function()
        state = not state
        sw.BackgroundColor3 = state and Color3.new(0,1,0) or Color3.new(0.5,0.5,0.5)
        sw.Text = state and "ON" or "OFF"
        callback(state)
    end)
    return state
end

-- ç»‘å®šæ§åˆ¶
AddButton("â–¶ å¯åŠ¨æ°¸ä¹…æ­»äº¡ & åˆ›å»ºåˆ†èº«", function()
    HatManager:Start()
end)
AddButton("â¹ åœæ­¢å¹¶æ¸…ç†", function()
    HatManager:Stop()
end)
AddButton("ğŸ¯ ç”©é£é¼ æ ‡æŒ‡å‘ç›®æ ‡", function()
    local mouse = Player:GetMouse()
    if mouse.Target then
        local target = mouse.Target:FindFirstAncestorOfClass("Model") or mouse.Target.Parent
        if target then
            HatManager:AddFlingTarget(target, 3)
        else
            Util.Notify("æœªæ‰¾åˆ°ç›®æ ‡æ¨¡å‹")
        end
    else
        Util.Notify("æ²¡æœ‰æŒ‡å‘ä»»ä½•ç‰©ä½“")
    end
end)
AddButton("ğŸ§¹ æ¸…ç©ºç”©é£ç›®æ ‡", function()
    table.clear(HatManager.flingTargets)
    Util.Notify("ç”©é£é˜Ÿåˆ—å·²æ¸…ç©º")
end)

AddSwitch("ğŸ” å¯ç”¨å¸½å­ç¢°æ’", HatManager.collideEnabled, function(s)
    HatManager.collideEnabled = s
    for _,hat in ipairs(HatManager:GetAllHats()) do
        local handle = hat:FindFirstChild("Handle")
        if handle then handle.CanCollide = s end
    end
end)
AddSwitch("ğŸ–± è·Ÿéšåˆ†èº« (åˆ†èº«ç”±é¼ æ ‡ç§»åŠ¨)", true, function(s)
    HatManager.followClone = s
end)

-- Netlessé€Ÿåº¦è°ƒèŠ‚
local sliderContainer = Util.Instance("Frame", Content)
sliderContainer.Size = UDim2.new(1,-10,0,40)
sliderContainer.BackgroundTransparency = 1
local sliderLabel = Util.Instance("TextLabel", sliderContainer)
sliderLabel.AnchorPoint = Vector2.new(0,0.5)
sliderLabel.Position = UDim2.new(0,5,0.5,0)
sliderLabel.Size = UDim2.new(0.4,0,1,0)
sliderLabel.BackgroundTransparency = 1
sliderLabel.Text = "Netlessé€Ÿåº¦"
sliderLabel.TextColor3 = Color3.new(1,1,1)
sliderLabel.TextSize = 16
local sliderInput = Util.Instance("TextBox", sliderContainer)
sliderInput.AnchorPoint = Vector2.new(1,0.5)
sliderInput.Position = UDim2.new(1,-5,0.5,0)
sliderInput.Size = UDim2.new(0,60,0,30)
sliderInput.BackgroundColor3 = Color3.new(0.3,0.3,0.3)
sliderInput.Text = tostring(HatManager.netlessSpeed)
sliderInput.TextColor3 = Color3.new(1,1,1)
sliderInput.TextSize = 16
sliderInput.BorderSizePixel = 0
Util.Instance("UICorner", sliderInput).CornerRadius = UDim.new(0,4)
sliderInput.FocusLost:Connect(function()
    local n = tonumber(sliderInput.Text)
    if n then
        HatManager.netlessSpeed = math.clamp(n, 20, 100)
        sliderInput.Text = tostring(HatManager.netlessSpeed)
    else
        sliderInput.Text = tostring(HatManager.netlessSpeed)
    end
end)

-- åˆå§‹æç¤º
Util.Notify("ğŸ© å®Œæ•´ç‰ˆå·²åŠ è½½ï¼Œç‚¹å‡»å¯åŠ¨æŒ‰é’®")

-- æ˜¾ç¤ºUI
MainFrame.Visible = true
